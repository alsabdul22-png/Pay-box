// ========================
// TRADU√á√ïES / TRANSLATIONS
// ========================

// Mehrsprachige Texte (i18n)
const translations = {
    de: {
        appName: 'PayBox',
        articles: 'Artikel',
        newArticle: 'Neuer Artikel',
        selectImage: 'Bild ausw√§hlen',
        addButton: '+ Hinzuf√ºgen',
        login: 'Anmelden',
        loginButton: 'Anmelden',
        userPlaceholder: 'Benutzer',
        passwordPlaceholder: 'Passwort',
        loginError: 'Ung√ºltige Anmeldedaten',
        cart: 'Warenkorb',
        emptyCart: 'Warenkorb ist leer',
        total: 'Gesamt:',
        cancel: 'Abbrechen',
        cash: 'üíµ Bargeld',
        card: 'üí≥ Karte',
        openCash: 'üîì Kasse √ñffnen',
        receiptQuestion: 'Quittung?',
        receiptAsk: 'M√∂chten Sie eine Quittung?',
        yes: '‚úì Ja, drucken',
        no: '‚úï Nein',
        paymentMethod: 'Zahlungsart',
        completed: 'Zahlung abgeschlossen',
        scanHint: 'Barcode einscannen oder manuell eingeben',
        categoryInfo: 'Das System unterst√ºtzt nun eine professionelle Produktkategorisierung.',
        selectUser: 'Benutzer ausw√§hlen',
        selectUserHint: 'W√§hlen Sie einen Benutzer f√ºr den Kassiervorgang',
        dailyClosing: 'Tagesabschluss',
        dailyClosingReport: 'Tagesabschlussbericht',
        totalSales: 'Gesamtumsatz',
        customersCount: 'Anzahl Kunden',
        noPurchases: 'Keine Verk√§ufe',
        dailyClosingSummary: 'Zusammenfassung des Tagesabschlusses',
        backOffice: 'Back-Office',
        backOfficePassword: 'Back-Office Passwort',
        enterBackOfficePassword: 'Bitte geben Sie das Passwort ein:',
        invalidPassword: 'Falsches Passwort!',
        ok: 'OK',
        dashboard: '√úbersicht',
        cashierReconciliation: 'Kassenabrechnung',
        salesAnalysis: 'Verkaufsanalyse',
        productManagement: 'Produktverwaltung',
        inventoryManagement: 'Lagerverwaltung',
        employeeManagement: 'Mitarbeiterverwaltung',
        todaySales: 'Heutige Ums√§tze',
        todayTransactions: 'Transaktionen',
        avgTicket: 'Durchschn. Ticket',
        topProduct: 'Top Artikel',
        salesByEmployee: 'Verk√§ufe nach Mitarbeiter',
        register: 'Kasse/Register',
        expectedCash: 'Erwartetes Bargeld',
        actualCash: 'Gez√§hltes Bargeld',
        cardTransactions: 'Kartentransaktionen',
        difference: 'Differenz',
        saveReconciliation: 'Abrechnung speichern',
        generate: 'Generieren',
        success: 'Erfolgreich!'
        ,madeBy: 'Erstellt von Abdulrahman Alshouly'
        ,about: 'Info'
        ,aboutTitle: '√úber PayBox'
        ,aboutBody: 'PayBox POS & Back-Office System. Entwickelt von Abdulrahman Alshouly.'
    },
    en: {
        appName: 'PayBox',
        articles: 'Articles',
        newArticle: 'New Article',
        selectImage: 'Select Image',
        addButton: '+ Add',
        login: 'Login',
        loginButton: 'Login',
        userPlaceholder: 'User',
        passwordPlaceholder: 'Password',
        loginError: 'Invalid credentials',
        cart: 'Shopping Cart',
        emptyCart: 'Cart is empty',
        total: 'Total:',
        cancel: 'Cancel',
        cash: 'üíµ Cash',
        card: 'üí≥ Card',
        openCash: 'üîì Open Cash',
        receiptQuestion: 'Receipt?',
        receiptAsk: 'Would you like a receipt?',
        yes: '‚úì Yes, print',
        no: '‚úï No',
        paymentMethod: 'Payment Method',
        completed: 'Payment completed',
        scanHint: 'Scan barcode or enter manually',
        categoryInfo: 'The system now supports professional product categorization.',
        selectUser: 'Select User',
        selectUserHint: 'Choose a user for the transaction',
        dailyClosing: 'Daily Closing',
        dailyClosingReport: 'Daily Closing Report',
        totalSales: 'Total Sales',
        customersCount: 'Customer Count',
        noPurchases: 'No Sales',
        dailyClosingSummary: 'Daily Closing Summary',
        backOffice: 'Back-Office',
        backOfficePassword: 'Back-Office Password',
        enterBackOfficePassword: 'Please enter the password:',
        invalidPassword: 'Wrong password!',
        ok: 'OK',
        dashboard: 'Dashboard',
        cashierReconciliation: 'Cash Reconciliation',
        salesAnalysis: 'Sales Analysis',
        productManagement: 'Product Management',
        inventoryManagement: 'Inventory Management',
        employeeManagement: 'Employee Management',
        todaySales: 'Today Sales',
        todayTransactions: 'Transactions',
        avgTicket: 'Avg Ticket',
        topProduct: 'Top Product',
        salesByEmployee: 'Sales by Employee',
        register: 'Register',
        expectedCash: 'Expected Cash',
        actualCash: 'Counted Cash',
        cardTransactions: 'Card Transactions',
        difference: 'Difference',
        saveReconciliation: 'Save Reconciliation',
        generate: 'Generate',
        success: 'Success!'
        ,madeBy: 'Made by Abdulrahman Alshouly'
        ,about: 'About'
        ,aboutTitle: 'About PayBox'
        ,aboutBody: 'PayBox POS & Back-Office System. Made by Abdulrahman Alshouly.'
    },
    ar: {
        appName: 'PayBox',
        articles: 'ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™',
        newArticle: 'ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ',
        selectImage: 'ÿßÿÆÿ™ÿ± ÿµŸàÿ±ÿ©',
        addButton: '+ ÿ•ÿ∂ÿßŸÅÿ©',
        login: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ',
        loginButton: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ',
        userPlaceholder: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
        passwordPlaceholder: 'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
        loginError: 'ÿ®ŸäÿßŸÜÿßÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©',
        cart: 'ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ',
        emptyCart: 'ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©',
        total: 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:',
        cancel: 'ÿ•ŸÑÿ∫ÿßÿ°',
        cash: 'üíµ ŸÜŸÇÿØÿßŸã',
        card: 'üí≥ ÿ®ÿ∑ÿßŸÇÿ©',
        openCash: 'üîì ŸÅÿ™ÿ≠ ÿßŸÑÿØÿ±ÿ¨',
        receiptQuestion: 'ÿßŸÑÿ•ŸäÿµÿßŸÑÿü',
        receiptAsk: 'ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ŸäÿµÿßŸÑÿßŸãÿü',
        yes: '‚úì ŸÜÿπŸÖÿå ÿßÿ∑ÿ®ÿπ',
        no: '‚úï ŸÑÿß',
        paymentMethod: 'ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ',
        completed: 'ÿ™ŸÖÿ™ ÿßŸÑÿØŸÅÿπ',
        scanHint: 'ÿßŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿ£Ÿà ÿ£ÿØÿÆŸÑŸá ŸäÿØŸàŸäŸãÿß',
        categoryInfo: 'ŸäÿØÿπŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¢ŸÜ ÿ™ÿµŸÜŸäŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ®ÿ¥ŸÉŸÑ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä.',
        selectUser: 'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ',
        selectUserHint: 'ÿßÿÆÿ™ÿ± ŸÖÿ≥ÿ™ÿÆÿØŸÖŸãÿß ŸÑŸÑŸÖÿπÿßŸÖŸÑÿ©',
        dailyClosing: 'ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸäŸàŸÖŸä',
        dailyClosingReport: 'ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸäŸàŸÖŸä',
        totalSales: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™',
        customersCount: 'ÿπÿØÿØ ÿßŸÑÿπŸÖŸÑÿßÿ°',
        noPurchases: 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ®Ÿäÿπÿßÿ™',
        dailyClosingSummary: 'ŸÖŸÑÿÆÿµ ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸäŸàŸÖŸä',
        backOffice: 'ŸÖŸÉÿ™ÿ® ÿßŸÑÿπŸÖŸÑŸäÿßÿ™',
        backOfficePassword: 'ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ŸÖŸÉÿ™ÿ® ÿßŸÑÿπŸÖŸÑŸäÿßÿ™',
        enterBackOfficePassword: 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±:',
        invalidPassword: 'ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ÿÆÿßÿ∑ÿ¶ÿ©!',
        ok: 'ŸÖŸàÿßŸÅŸÇ',
        dashboard: 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ',
        cashierReconciliation: 'ŸÖÿ∑ÿßÿ®ŸÇÿ© ÿßŸÑÿµŸÜÿØŸàŸÇ',
        salesAnalysis: 'ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™',
        productManagement: 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™',
        inventoryManagement: 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ',
        employeeManagement: 'ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ',
        todaySales: 'ŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑŸäŸàŸÖ',
        todayTransactions: 'ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™',
        avgTicket: 'ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©',
        topProduct: 'ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑÿ£ŸÅÿ∂ŸÑ',
        salesByEmployee: 'ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸàÿ∏ŸÅ',
        register: 'ÿßŸÑÿ≥ÿ¨ŸÑ',
        expectedCash: 'ÿßŸÑŸÜŸÇÿØ ÿßŸÑŸÖÿ™ŸàŸÇÿπ',
        actualCash: 'ÿßŸÑŸÜŸÇÿØ ÿßŸÑŸÖÿπÿØŸàÿØ',
        cardTransactions: 'ŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©',
        difference: 'ÿßŸÑŸÅÿ±ŸÇ',
        saveReconciliation: 'ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿ©',
        generate: 'ÿ™ŸàŸÑŸäÿØ',
        success: 'ŸÜÿ¨ÿ≠!'
        ,madeBy: 'ÿ™ŸÖ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ° ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿπÿ®ÿØ ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ¥ŸàŸÑŸä'
        ,about: 'ÿ≠ŸàŸÑ'
        ,aboutTitle: 'ÿ≠ŸàŸÑ PayBox'
        ,aboutBody: 'ŸÜÿ∏ÿßŸÖ ŸÜŸÇÿßÿ∑ ÿßŸÑÿ®Ÿäÿπ Ÿàÿ•ÿØÿßÿ±ÿ© Back-Office. ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿπÿ®ÿØ ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ¥ŸàŸÑŸä.'
    }
};

// Kategoriebeschreibungstexte
const categoryInfoTexts = {
    de: 'Das System unterst√ºtzt nun eine professionelle Produktkategorisierung. Produkte k√∂nnen beim Anlegen einer der vordefinierten Kategorien wie Lebensmittel, K√§se & Fleisch, Gem√ºse, Getr√§nke, S√º√üwaren oder Sonstiges zugeordnet werden.',
    en: 'The system now supports professional product categorization. When adding a product, you can assign it to one of the predefined categories such as Food, Cheese & Meat, Vegetables, Drinks, Sweets, or Other.',
    ar: 'ŸäÿØÿπŸÖ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¢ŸÜ ÿ™ÿµŸÜŸäŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ®ÿ¥ŸÉŸÑ ÿßÿ≠ÿ™ÿ±ÿßŸÅŸä. ÿπŸÜÿØ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØÿå ŸäŸÖŸÉŸÜŸÉ ÿ™ÿπŸäŸäŸÜŸá ÿ•ŸÑŸâ ÿ•ÿ≠ÿØŸâ ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ© ŸÖÿ≥ÿ®ŸÇŸãÿß.'
};

// ========================
// GLOBALE VARIABLEN
// ========================

const PRODUCT_CATEGORIES = [
    { key: 'food', label: 'Lebensmittel' },
    { key: 'cheese_meat', label: 'K√§se & Fleisch' },
    { key: 'vegetables', label: 'Gem√ºse' },
    { key: 'drinks', label: 'Getr√§nke' },
    { key: 'sweets', label: 'S√º√üwaren' },
    { key: 'other', label: 'Sonstiges' }
];

let currentLanguage = 'de';
let currentUser = null;
const users = ['Ahmed', 'Aboud', 'Jawad'];
let products = [];
let cart = [];
let nextProductId = 7;
let currentProductImage = null;
const APP_VERSION = '1.0.0';
const AUTHOR_EMAIL = 'alsabdul22@gmail.com';

let salesData = {
    'Ahmed': { totalSales: 0, customersCount: 0 },
    'Aboud': { totalSales: 0, customersCount: 0 },
    'Jawad': { totalSales: 0, customersCount: 0 }
};

// ========================
// SCREEN MANAGEMENT
// ========================

function showUserSelection() {
    document.getElementById('userSelectionScreen').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('dailyClosingScreen').style.display = 'none';
}

function showMainApp() {
    document.getElementById('userSelectionScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';
    document.getElementById('dailyClosingScreen').style.display = 'none';
}

function showDailyClosing() {
    document.getElementById('userSelectionScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('dailyClosingScreen').style.display = 'flex';
}

function backToMainApp() {
    showMainApp();
}

// ========================
// BENUTZER-MANAGEMENT
// ========================

function selectUser(userName) {
    currentUser = userName;
    localStorage.setItem('currentUser', userName);
    updateUserButton();
    showMainApp();
}

function changeUser() {
    showUserSelection();
}

function updateUserButton() {
    const btn = document.getElementById('currentUserBtn');
    if (btn) {
        btn.textContent = currentUser ? `üë§ ${currentUser}` : 'üë§ Benutzer';
    }
}

// ========================
// SPRACH-VERWALTUNG
// ========================

function changeLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('language', lang);
    updatePageLanguage();
}

function updatePageLanguage() {
    const t = translations[currentLanguage];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (t[key]) {
            if (el.tagName === 'BUTTON' || el.tagName === 'H1' || el.tagName === 'H2' || el.tagName === 'H3' || el.tagName === 'SPAN' || el.tagName === 'P') {
                el.textContent = t[key];
            }
        }
    });
    
    const productNameInput = document.getElementById('productName');
    const productPriceInput = document.getElementById('productPrice');
    
    if (productNameInput) {
        productNameInput.placeholder = currentLanguage === 'de' ? 'Artikelname' : 
                                      currentLanguage === 'en' ? 'Article Name' : 'ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨';
    }
    if (productPriceInput) {
        productPriceInput.placeholder = currentLanguage === 'de' ? 'Preis' : 
                                       currentLanguage === 'en' ? 'Price' : 'ÿßŸÑÿ≥ÿπÿ±';
    }
    
    if (currentLanguage === 'ar') {
        document.documentElement.dir = 'rtl';
        document.body.style.direction = 'rtl';
    } else {
        document.documentElement.dir = 'ltr';
        document.body.style.direction = 'ltr';
    }
    updateCategoryInfoText();
    // update dynamic about body if present
    const aboutEl = document.getElementById('aboutBodyText');
    if (aboutEl) {
        aboutEl.innerHTML = buildAboutBody();
    }
}

function buildAboutBody() {
    const t = translations[currentLanguage];
    const base = t.aboutBody || '';
    const email = `<a href=\"mailto:${AUTHOR_EMAIL}\">${AUTHOR_EMAIL}</a>`;
    return `${base} <br><strong>Version:</strong> ${APP_VERSION} <br><strong>Kontakt:</strong> ${email}`;
}

function updateCategoryInfoText() {
    const infoDiv = document.getElementById('categoryInfo');
    if (infoDiv) {
        infoDiv.textContent = categoryInfoTexts[currentLanguage] || categoryInfoTexts['de'];
    }
}

// ========================
// VERKAUFSDATEN
// ========================

function loadSalesData() {
    const savedData = localStorage.getItem('salesData');
    if (savedData) {
        salesData = JSON.parse(savedData);
    }
}

function saveSalesData() {
    localStorage.setItem('salesData', JSON.stringify(salesData));
}

function openDailyClosing() {
    loadSalesData();
    generateDailyClosingReport();
    showDailyClosing();
}

function closeDailyClosing() {
    showMainApp();
}

function generateDailyClosingReport() {
    loadSalesData();
    const t = translations[currentLanguage];
    
    let reportHTML = `<div class="daily-closing-report-header"><strong>${t.dailyClosingSummary}</strong></div>`;
    reportHTML += '<div class="daily-closing-items">';
    
    let totalAllSales = 0;
    let totalAllCustomers = 0;
    
    users.forEach(user => {
        const data = salesData[user] || { totalSales: 0, customersCount: 0 };
        totalAllSales += data.totalSales;
        totalAllCustomers += data.customersCount;
        
        const salesDisplay = data.totalSales > 0 ? `‚Ç¨ ${data.totalSales.toFixed(2)}` : `<span class="no-sales">${t.noPurchases}</span>`;
        
        reportHTML += `
            <div class="daily-closing-user-item">
                <div class="user-name">üë§ ${user}</div>
                <div class="user-stats">
                    <div class="stat">
                        <span class="stat-label">${t.totalSales}:</span>
                        <span class="stat-value">${salesDisplay}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">${t.customersCount}:</span>
                        <span class="stat-value">${data.customersCount}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    reportHTML += '</div>';
    reportHTML += `
        <div class="daily-closing-totals">
            <div class="total-row">
                <span><strong>${t.totalSales}:</strong></span>
                <span class="total-amount">‚Ç¨ ${totalAllSales.toFixed(2)}</span>
            </div>
            <div class="total-row">
                <span><strong>${t.customersCount}:</strong></span>
                <span class="total-amount">${totalAllCustomers}</span>
            </div>
        </div>
    `;
    
    document.getElementById('dailyClosingContent').innerHTML = reportHTML;
}

// ========================
// PRODUKTE
// ========================

const defaultProducts = [
    { id: 1, name: 'Kaffee', price: 2.50, barcode: '123456', category: 'drinks' },
    { id: 2, name: 'Wasser', price: 1.50, barcode: '123457', category: 'drinks' },
    { id: 3, name: 'Sandwich', price: 4.99, barcode: '123458', category: 'food' },
    { id: 4, name: 'Kuchen', price: 3.50, barcode: '123459', category: 'sweets' },
    { id: 5, name: 'Saft', price: 2.00, barcode: '123460', category: 'drinks' },
    { id: 6, name: 'Salat', price: 5.99, barcode: '123461', category: 'vegetables' }
];

function loadProducts() {
    const saved = localStorage.getItem('products');
    if (saved) {
        products = JSON.parse(saved);
    } else {
        products = defaultProducts;
        localStorage.setItem('products', JSON.stringify(products));
    }
}

function saveProducts() {
    localStorage.setItem('products', JSON.stringify(products));
}

function addProduct() {
    const name = document.getElementById('productName').value.trim();
    const price = parseFloat(document.getElementById('productPrice').value);
    const barcode = document.getElementById('productBarcode').value.trim() || null;
    const category = document.getElementById('productCategory').value;
    
    if (!name || !price || price <= 0) {
        alert('Bitte f√ºllen Sie alle erforderlichen Felder aus');
        return;
    }
    
    const newProduct = {
        id: nextProductId++,
        name,
        price,
        barcode,
        category,
        image: currentProductImage || null
    };
    
    products.push(newProduct);
    saveProducts();
    
    document.getElementById('productName').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productBarcode').value = '';
    document.getElementById('productCategory').value = 'food';
    document.getElementById('imagePreview').src = '';
    document.getElementById('imagePreviewSmall').textContent = 'üñºÔ∏è';
    currentProductImage = null;
    
    renderProducts();
}

function deleteProduct(e, id) {
    e.stopPropagation();
    if (confirm('Produkt wirklich l√∂schen?')) {
        products = products.filter(p => p.id !== id);
        saveProducts();
        renderProducts();
    }
}

function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            currentProductImage = e.target.result;
            document.getElementById('imagePreview').src = currentProductImage;
            document.getElementById('imagePreviewSmall').textContent = '‚úì';
        };
        reader.readAsDataURL(file);
    }
}

function renderProducts(categoryFilter = 'all') {
    const grid = document.getElementById('productsGrid');
    let filtered = products;
    
    if (categoryFilter && categoryFilter !== 'all') {
        filtered = products.filter(p => p.category === categoryFilter);
    }
    
    grid.innerHTML = filtered.map(p => `
        <div class="product-card" onclick="addToCart({id: ${p.id}, name: '${p.name}', price: ${p.price}})">
            <img src="${p.image || 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23333%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 fill=%22%23999%22 font-size=%2224%22%3E%F0%9F%96%BC%EF%B8%8F%3C/text%3E%3C/svg%3E'}" alt="${p.name}">
            <div class="product-info">
                <div class="product-name">${p.name}</div>
                <div class="product-price">‚Ç¨ ${p.price.toFixed(2)}</div>
            </div>
            <button class="delete-btn" onclick="deleteProduct(event, ${p.id})">‚úï</button>
        </div>
    `).join('');
}

function handleBarcodeInput(event) {
    if (event.key !== 'Enter') return;
    
    const barcode = document.getElementById('barcodeInput').value.trim();
    if (!barcode) return;
    
    const product = products.find(p => p.barcode && p.barcode.toLowerCase() === barcode.toLowerCase());
    
    if (product) {
        addToCart(product);
        document.getElementById('barcodeInput').value = '';
        document.getElementById('barcodeInput').focus();
        document.getElementById('barcodeInput').style.borderColor = '#00ff00';
        setTimeout(() => {
            document.getElementById('barcodeInput').style.borderColor = '';
        }, 300);
    } else {
        alert('Produkt nicht gefunden');
        document.getElementById('barcodeInput').value = '';
    }
}

function filterByCategory(categoryKey) {
    renderProducts(categoryKey);
}

function populateCategorySelect() {
    const select = document.getElementById('categorySelect');
    if (!select) return;
    select.innerHTML = '<option value="all">Alle Kategorien</option>' +
        PRODUCT_CATEGORIES.map(cat => `<option value="${cat.key}">${cat.label}</option>`).join('');
}

// ========================
// WARENKORB
// ========================

function addToCart(product) {
    const existingItem = cart.find(item => item.id === product.id);
    
    if (existingItem) {
        existingItem.quantity++;
    } else {
        cart.push({ ...product, quantity: 1 });
    }
    renderCart();
}

function removeFromCart(id) {
    cart = cart.filter(item => item.id !== id);
    renderCart();
}

function updateQuantity(id, qty) {
    const item = cart.find(item => item.id === id);
    if (item) {
        item.quantity = Math.max(1, qty);
        renderCart();
    }
}

function renderCart() {
    const cartItems = document.getElementById('cartItems');
    const totalEl = document.getElementById('total');
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<p class="empty-cart" data-i18n="emptyCart">Warenkorb ist leer</p>';
        totalEl.textContent = '‚Ç¨ 0,00';
        return;
    }
    
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    cartItems.innerHTML = cart.map(item => `
        <div class="cart-item">
            <div class="cart-item-info">
                <span class="cart-item-name">${item.name}</span>
                <span class="cart-item-price">‚Ç¨ ${item.price.toFixed(2)}</span>
            </div>
            <div class="cart-item-qty">
                <button onclick="updateQuantity(${item.id}, ${item.quantity - 1})">‚àí</button>
                <span>${item.quantity}</span>
                <button onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
            </div>
            <button class="remove-btn" onclick="removeFromCart(${item.id})">‚úï</button>
        </div>
    `).join('');
    
    totalEl.textContent = '‚Ç¨ ' + total.toFixed(2);
}

function clearCart() {
    if (cart.length > 0 && !confirm('Warenkorb wirklich leeren?')) {
        return;
    }
    cart = [];
    renderCart();
}

// ========================
// CHECKOUT & ZAHLUNG
// ========================

function openCash() {
    const audio = new Audio('data:audio/wav;base64,UklGRiYAAABXQVZFZm10IBAAAAABAAEAQB8AAAB9AAACABAAZGF0YQIAAAAAAA==');
    audio.play().catch(e => console.log('Audio-Fehler'));
    alert('üí≥ Kassenschublade √∂ffnen!\n\nDie Kassenschublade wurde ge√∂ffnet.');
}

function checkoutWithPayment(method) {
    if (cart.length === 0) return;
    if (!currentUser) {
        alert('Bitte w√§hlen Sie einen Benutzer aus');
        return;
    }
    
    window.currentPaymentMethod = method;
    if (method === 'cash') {
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const modal = document.getElementById('receiptQuestionModal');
        let inputRow = document.getElementById('cashGivenRow');
        if (!inputRow) {
            inputRow = document.createElement('div');
            inputRow.id = 'cashGivenRow';
            inputRow.style = 'margin-bottom:10px;text-align:center;';
            const quickAmounts = [5, 10, 20, 50, 100];
            const flagColors = ['#d90000', '#fff', '#111', '#1ca31c', '#d90000'];
            let quickBtns = quickAmounts.map((val, i) => {
                const color = flagColors[i];
                const textColor = (color === '#fff') ? '#111' : '#fff';
                return `<button type="button" class="quick-cash-btn" data-val="${val}" style="margin:0 2px 4px 2px;padding:2px 10px;background:${color};color:${textColor};border:1.5px solid #222;font-weight:bold;">${val} ‚Ç¨</button>`;
            }).join('');
            inputRow.innerHTML = `
                <div style="margin-bottom:4px;">${quickBtns}</div>
                Gegeben: <input id="cashGivenInput" type="number" min="0" step="0.01" style="width:80px;text-align:right;"> ‚Ç¨ <span id="changeInfo" style="margin-left:10px;color:#0af;font-weight:bold;"></span>
            `;
            modal.querySelector('.modal-content')?.prepend(inputRow);
        }
        const input = document.getElementById('cashGivenInput');
        const changeInfo = document.getElementById('changeInfo');
        input.value = '';
        changeInfo.textContent = '';
        inputRow.querySelectorAll('.quick-cash-btn').forEach(btn => {
            btn.onclick = () => {
                input.value = btn.getAttribute('data-val');
                input.dispatchEvent(new Event('input'));
                input.focus();
            };
        });
        const yesBtn = modal.querySelector('.btn-yes') || modal.querySelector('button[data-i18n="yes"]');
        if (yesBtn) yesBtn.disabled = true;
        input.oninput = function() {
            const given = parseFloat(input.value.replace(',', '.'));
            if (!isNaN(given) && given >= total) {
                const change = given - total;
                changeInfo.textContent = 'R√ºckgeld: ‚Ç¨ ' + change.toFixed(2);
                if (yesBtn) yesBtn.disabled = false;
                window.lastCashGiven = given;
                window.lastCashChange = change;
            } else {
                changeInfo.textContent = '';
                if (yesBtn) yesBtn.disabled = true;
                window.lastCashGiven = null;
                window.lastCashChange = null;
            }
        };
        modal.classList.add('show');
        input.focus();
        return;
    }
    document.getElementById('receiptQuestionModal').classList.add('show');
}

function closeReceiptQuestion(wantReceipt) {
    const modal = document.getElementById('receiptQuestionModal');
    modal.classList.remove('show');
    const inputRow = document.getElementById('cashGivenRow');
    if (inputRow) inputRow.remove();
    if (wantReceipt) {
        showReceipt();
    } else {
        if (currentUser && cart.length > 0) {
            loadSalesData();
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (!salesData[currentUser]) salesData[currentUser] = { totalSales: 0, customersCount: 0 };
            salesData[currentUser].totalSales += total;
            salesData[currentUser].customersCount += 1;
            saveSalesData();
        }
        cart = [];
        renderCart();
        alert('‚úì Zahlung abgeschlossen!\nKeine Quittung gedruckt.');
    }
    window.lastCashGiven = null;
    window.lastCashChange = null;
}

function showReceipt() {
    const method = window.currentPaymentMethod;
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const paymentMethodText = method === 'cash' ? 'üíµ Bargeld' : 'üí≥ Karte';
    let changeBlock = '';
    if (method === 'cash' && typeof window.lastCashGiven === 'number') {
        changeBlock = `<div class="receipt-change"><strong>Gegeben:</strong> ‚Ç¨ ${window.lastCashGiven.toFixed(2)}<br><strong>R√ºckgeld:</strong> ‚Ç¨ ${window.lastCashChange.toFixed(2)}</div>`;
    }
    
    if (currentUser && cart.length > 0) {
        loadSalesData();
        if (!salesData[currentUser]) salesData[currentUser] = { totalSales: 0, customersCount: 0 };
        salesData[currentUser].totalSales += total;
        salesData[currentUser].customersCount += 1;
        
        // Track product sales
        cart.forEach(item => {
            trackProductSale(item.id);
        });
        
        // Track register sales
        if (method === 'cash') {
            registerData['1'].cashSales += total;
        } else {
            registerData['1'].cardSales += total;
        }
        
        saveSalesData();
        saveBackOfficeData();
    }
    
    const receiptHTML = `
        ${cart.map(item => `
            <div class="receipt-item">
                <span class="receipt-item-name">${item.name} (${item.quantity}√ó)</span>
                <span class="receipt-item-price">‚Ç¨ ${(item.price * item.quantity).toFixed(2)}</span>
            </div>
        `).join('')}
        <div class="receipt-summary">
            <div class="receipt-total">
                <span>GESAMT:</span>
                <span>‚Ç¨ ${total.toFixed(2)}</span>
            </div>
        </div>
        ${changeBlock}
        <div class="receipt-payment">
            <strong>Zahlungsart:</strong> ${paymentMethodText}
        </div>
        <div class="receipt-time">
            ‚úì Zahlung abgeschlossen<br>
            ${new Date().toLocaleString('de-DE')}
        </div>
    `;
    document.getElementById('receiptContent').innerHTML = receiptHTML;
    document.getElementById('receiptModal').classList.add('show');
    cart = [];
    renderCart();
    window.lastCashGiven = null;
    window.lastCashChange = null;
}

function closeReceipt() {
    document.getElementById('receiptModal').classList.remove('show');
}

// ========================
// ABOUT MODAL
// ========================

function showAbout() {
    const modal = document.getElementById('aboutModal');
    if (!modal) return;
    modal.style.display = 'flex';
    document.getElementById('aboutModal').querySelector('.modal-content').focus();
}

function closeAbout() {
    const modal = document.getElementById('aboutModal');
    if (!modal) return;
    modal.style.display = 'none';
}

// ========================
// UHRZEIT
// ========================

function updateTime() {
    const now = new Date();
    const timeEl = document.getElementById('time');
    if (timeEl) {
        timeEl.textContent = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
}

// ========================
// INITIALISIERUNG
// ========================

document.addEventListener('DOMContentLoaded', () => {
    const savedLanguage = localStorage.getItem('language') || 'de';
    const languageSelectScreen = document.getElementById('languageSelectScreen');
    const languageSelect = document.getElementById('languageSelect');
    
    if (languageSelectScreen) languageSelectScreen.value = savedLanguage;
    if (languageSelect) languageSelect.value = savedLanguage;
    
    changeLanguage(savedLanguage);
    updateTime();
    setInterval(updateTime, 1000);
    
    if (!localStorage.getItem('products')) {
        localStorage.setItem('products', JSON.stringify(defaultProducts));
    }
    
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser && users.includes(savedUser)) {
        currentUser = savedUser;
        updateUserButton();
        showMainApp();
    } else {
        showUserSelection();
    }
    
    loadProducts();
    populateCategorySelect();
    filterByCategory('all');
    const select = document.getElementById('categorySelect');
    if (select) {
        select.value = 'all';
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        document.getElementById('receiptModal').classList.remove('show');
    }
});

// ========================
// BACK-OFFICE MANAGEMENT
// ========================

let registerData = {
    '1': { cashSales: 0, cardSales: 0, lastReconciliation: null },
    '2': { cashSales: 0, cardSales: 0, lastReconciliation: null }
};

let productSalesCount = {};
let employeeShifts = {
    'Ahmed': { shiftStart: null, transactions: 0, totalSales: 0 },
    'Aboud': { shiftStart: null, transactions: 0, totalSales: 0 },
    'Jawad': { shiftStart: null, transactions: 0, totalSales: 0 }
};

let inventoryData = {};
let backOfficeUser = null;
let backOfficeRole = 'admin'; // admin, manager, employee
let backofficePassword = localStorage.getItem('backofficePassword') || '2009';

function showBackOffice() {
    // Show password modal instead of directly showing back office
    document.getElementById('backofficePasswordModal').style.display = 'flex';
    document.getElementById('backofficePasswordInput').value = '';
    document.getElementById('passwordError').style.display = 'none';
    document.getElementById('backofficePasswordInput').focus();
}

function verifyBackofficePassword() {
    const password = document.getElementById('backofficePasswordInput').value;
    if (password === backofficePassword) {
        closeBackofficePasswordModal();
        enterBackOffice();
    } else {
        const errorMsg = document.getElementById('passwordError');
        errorMsg.textContent = translations[currentLanguage].invalidPassword;
        errorMsg.style.display = 'block';
        document.getElementById('backofficePasswordInput').value = '';
        document.getElementById('backofficePasswordInput').focus();
    }
}

function showChangePasswordModal() {
    const modal = document.getElementById('changePasswordModal');
    if (!modal) return;
    modal.style.display = 'flex';
    document.getElementById('changeOldPassword').value = '';
    document.getElementById('changeNewPassword').value = '';
    document.getElementById('changeConfirmPassword').value = '';
    document.getElementById('changePasswordError').style.display = 'none';
    document.getElementById('changeOldPassword').focus();
}

function closeChangePasswordModal() {
    const modal = document.getElementById('changePasswordModal');
    if (!modal) return;
    modal.style.display = 'none';
}

function changeBackofficePassword() {
    const oldP = document.getElementById('changeOldPassword').value;
    const newP = document.getElementById('changeNewPassword').value;
    const conf = document.getElementById('changeConfirmPassword').value;
    const err = document.getElementById('changePasswordError');

    if (!oldP || !newP) {
        err.textContent = 'Bitte alle Felder ausf√ºllen.';
        err.style.display = 'block';
        return;
    }
    if (oldP !== backofficePassword) {
        err.textContent = 'Altes Passwort ist falsch.';
        err.style.display = 'block';
        return;
    }
    if (newP !== conf) {
        err.textContent = 'Neue Passw√∂rter stimmen nicht √ºberein.';
        err.style.display = 'block';
        return;
    }

    backofficePassword = newP;
    localStorage.setItem('backofficePassword', backofficePassword);
    closeChangePasswordModal();
    alert('Passwort erfolgreich ge√§ndert.');
}

function handlePasswordKeyPress(event) {
    if (event.key === 'Enter') {
        verifyBackofficePassword();
    }
}

function closeBackofficePasswordModal() {
    document.getElementById('backofficePasswordModal').style.display = 'none';
    document.getElementById('backofficePasswordInput').value = '';
    document.getElementById('passwordError').style.display = 'none';
}

function requestBackofficeAccess() {
    const userEmail = "alsabdul22@gmail.com";
    const subject = encodeURIComponent("Back-Office Access Request");
    const timestamp = new Date().toLocaleString('de-DE');
    const user = currentUser || 'Unknown';
    const body = encodeURIComponent(`Hallo,\n\nIch ben√∂tige Zugriff auf das Back-Office.\n\nBenutzer: ${user}\nZeit: ${timestamp}`);
    
    window.location.href = `mailto:${userEmail}?subject=${subject}&body=${body}`;
    
    // Show confirmation message
    setTimeout(() => {
        const errorDiv = document.getElementById('passwordError');
        errorDiv.textContent = 'E-Mail-Client wird ge√∂ffnet...';
        errorDiv.style.display = 'block';
        errorDiv.style.color = '#81c784';
    }, 100);
}

function enterBackOffice() {
    document.getElementById('userSelectionScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('dailyClosingScreen').style.display = 'none';
    document.getElementById('backOfficeScreen').style.display = 'flex';
    backOfficeRole = 'admin'; // Default role
    document.getElementById('backOfficeUserRole').textContent = 'Admin';
    loadBackOfficeData();
}

function exitBackOffice() {
    document.getElementById('backOfficeScreen').style.display = 'none';
    showMainApp();
}

function showBackOfficeTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.backoffice-tab').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab
    const tabElement = document.getElementById(tabName + 'Tab');
    if (tabElement) {
        tabElement.style.display = 'block';
    }
    
    // Mark button as active
    event.target.classList.add('active');
    
    // Load tab-specific data
    if (tabName === 'dashboard') loadDashboard();
    if (tabName === 'articles') loadArticlesView();
    if (tabName === 'cashier') loadCashierView();
    if (tabName === 'sales') loadSalesView();
    if (tabName === 'inventory') loadInventoryView();
    if (tabName === 'employees') loadEmployeesView();
}

function loadBackOfficeData() {
    const backofficeData = localStorage.getItem('backofficeData');
    if (backofficeData) {
        const data = JSON.parse(backofficeData);
        registerData = data.registers || registerData;
        productSalesCount = data.productSales || {};
        employeeShifts = data.employees || employeeShifts;
        inventoryData = data.inventory || {};
    }
    loadDashboard();
}

function saveBackOfficeData() {
    const backofficeData = {
        registers: registerData,
        productSales: productSalesCount,
        employees: employeeShifts,
        inventory: inventoryData
    };
    localStorage.setItem('backofficeData', JSON.stringify(backofficeData));
}

function loadDashboard() {
    // Calculate KPIs
    let todayTotalSales = 0;
    let totalTransactions = 0;
    let topProduct = '';
    let topProductCount = 0;
    
    // Get today's sales from salesData
    Object.keys(salesData).forEach(user => {
        todayTotalSales += salesData[user].totalSales;
        totalTransactions += salesData[user].customersCount;
    });
    
    // Find top product
    Object.keys(productSalesCount).forEach(productId => {
        if (productSalesCount[productId] > topProductCount) {
            topProductCount = productSalesCount[productId];
            const product = products.find(p => p.id == productId);
            topProduct = product ? product.name : '-';
        }
    });
    
    const avgTicket = totalTransactions > 0 ? (todayTotalSales / totalTransactions).toFixed(2) : 0;
    
    document.getElementById('kpiTodaySales').textContent = '‚Ç¨' + todayTotalSales.toFixed(2);
    document.getElementById('kpiTransactions').textContent = totalTransactions;
    document.getElementById('kpiAvgTicket').textContent = '‚Ç¨' + avgTicket;
    document.getElementById('kpiTopProduct').textContent = topProduct;
    
    // Draw employee sales chart
    let chartHTML = '<table class="data-table"><tr><th>Mitarbeiter</th><th>Umsatz</th><th>Transaktionen</th></tr>';
    Object.keys(salesData).forEach(user => {
        chartHTML += `<tr><td>${user}</td><td>‚Ç¨${salesData[user].totalSales.toFixed(2)}</td><td>${salesData[user].customersCount}</td></tr>`;
    });
    chartHTML += '</table>';
    document.getElementById('employeeSalesChart').innerHTML = chartHTML;
    updatePageLanguage();
}


function loadArticlesView() {
    document.getElementById('articleCount').textContent = products.length;
    renderArticlesList();
}

function renderArticlesList() {
    let html = '';
    products.forEach(product => {
        const sales = productSalesCount[product.id] || 0;
        html += `
            <div class="article-item">
                <div class="article-item-header">
                    <strong>${product.name}</strong>
                    <span class="article-sales">Verk√§ufe: ${sales}</span>
                </div>
                <div class="article-item-details">
                    <span>üí∞ ‚Ç¨${product.price.toFixed(2)}</span>
                    <span>üìÅ ${product.category}</span>
                    ${product.barcode ? `<span>üìä ${product.barcode}</span>` : ''}
                </div>
                <div class="article-item-actions">
                    <button class="btn-edit-article" onclick="editArticle(${product.id})">‚úèÔ∏è Bearbeiten</button>
                    <button class="btn-delete-article" onclick="deleteArticleConfirm(${product.id})">üóëÔ∏è L√∂schen</button>
                </div>
            </div>
        `;
    });
    document.getElementById('backofficeArticlesList').innerHTML = html || '<p style="color:#888;">Noch keine Artikel vorhanden</p>';
}

function filterArticlesList() {
    const searchTerm = document.getElementById('articleSearch').value.toLowerCase();
    document.querySelectorAll('.article-item').forEach(item => {
        const productName = item.querySelector('strong').textContent.toLowerCase();
        item.style.display = productName.includes(searchTerm) ? 'flex' : 'none';
    });
}

function addProductFromBackOffice() {
    const name = document.getElementById('boProductName').value.trim();
    const price = parseFloat(document.getElementById('boProductPrice').value);
    const barcode = document.getElementById('boProductBarcode').value.trim();
    const category = document.getElementById('boProductCategory').value;
    
    if (!name || !price || price <= 0) {
        alert('Bitte Artikelname und Preis eingeben!');
        return;
    }
    
    const newProduct = {
        id: nextProductId++,
        name: name,
        price: price,
        barcode: barcode || null,
        category: category,
        image: null
    };
    
    products.push(newProduct);
    saveProducts();
    
    // Clear form
    document.getElementById('boProductName').value = '';
    document.getElementById('boProductPrice').value = '';
    document.getElementById('boProductBarcode').value = '';
    document.getElementById('boProductCategory').value = 'other';
    
    // Refresh list and POS
    loadArticlesView();
    renderProducts();
    populateCategorySelect();
    updatePageLanguage();
    alert('Artikel hinzugef√ºgt!');
}

function editArticle(productId) {
    const product = products.find(p => p.id === productId);
    if (product) {
        document.getElementById('boProductName').value = product.name;
        document.getElementById('boProductPrice').value = product.price;
        document.getElementById('boProductBarcode').value = product.barcode || '';
        document.getElementById('boProductCategory').value = product.category;
        
        // Mark for edit and change button text
        window.editingProductId = productId;
        const btn = document.querySelector('[onclick="addProductFromBackOffice()"]');
        if (btn) {
            btn.textContent = 'üíæ √Ñnderungen speichern';
            btn.onclick = function() { saveArticleEdit(productId); };
        }
    }
}

function saveArticleEdit(productId) {
    const product = products.find(p => p.id === productId);
    if (product) {
        product.name = document.getElementById('boProductName').value.trim();
        product.price = parseFloat(document.getElementById('boProductPrice').value);
        product.barcode = document.getElementById('boProductBarcode').value.trim() || null;
        product.category = document.getElementById('boProductCategory').value;
        
        saveProducts();
        
        document.getElementById('boProductName').value = '';
        document.getElementById('boProductPrice').value = '';
        document.getElementById('boProductBarcode').value = '';
        document.getElementById('boProductCategory').value = 'other';
        window.editingProductId = null;
        
        const btn = document.querySelector('[onclick="saveArticleEdit(productId)"]');
        if (btn) {
            btn.textContent = '‚ûï Artikel hinzuf√ºgen';
            btn.onclick = function() { addProductFromBackOffice(); };
        }
        
        loadArticlesView();
        renderProducts();
        populateCategorySelect();
        updatePageLanguage();
        alert('Artikel aktualisiert!');
    }
}

function deleteArticleConfirm(productId) {
    const product = products.find(p => p.id === productId);
    if (product && confirm(`Artikel "${product.name}" wirklich l√∂schen?`)) {
        deleteProduct(productId);
        loadArticlesView();
        renderProducts();
        populateCategorySelect();
        updatePageLanguage();
    }
}

function loadCashierView() {
    updateRegisterSummary();
}

function updateRegisterSummary() {
    const register = document.getElementById('registerSelect').value;
    
    let expectedCash = 0;
    let cardTotal = 0;
    
    if (register === 'all') {
        expectedCash = registerData['1'].cashSales + registerData['2'].cashSales;
        cardTotal = registerData['1'].cardSales + registerData['2'].cardSales;
    } else {
        expectedCash = registerData[register].cashSales;
        cardTotal = registerData[register].cardSales;
    }
    
    document.getElementById('expectedCash').value = expectedCash.toFixed(2);
    document.getElementById('cardTransactions').value = cardTotal.toFixed(2);
    document.getElementById('actualCash').value = '';
    document.getElementById('cashDifference').textContent = '‚Ç¨0,00';
    document.getElementById('differenceAlert').innerHTML = '';
}

function calculateDifference() {
    const expected = parseFloat(document.getElementById('expectedCash').value) || 0;
    const actual = parseFloat(document.getElementById('actualCash').value) || 0;
    const difference = actual - expected;
    
    const diffElement = document.getElementById('cashDifference');
    const alertElement = document.getElementById('differenceAlert');
    
    diffElement.textContent = '‚Ç¨' + difference.toFixed(2);
    
    if (difference > 0) {
        diffElement.style.color = '#00d400';
        alertElement.innerHTML = `<div class="alert-success">‚úì Plus: ‚Ç¨${difference.toFixed(2)}</div>`;
    } else if (difference < 0) {
        diffElement.style.color = '#ff3b30';
        alertElement.innerHTML = `<div class="alert-error">‚úó Minus: ‚Ç¨${Math.abs(difference).toFixed(2)}</div>`;
    } else {
        diffElement.style.color = '#00d4ff';
        alertElement.innerHTML = '';
    }
}

function saveCashierReconciliation() {
    const register = document.getElementById('registerSelect').value;
    const actual = parseFloat(document.getElementById('actualCash').value);
    
    if (register !== 'all' && !isNaN(actual)) {
        registerData[register].lastReconciliation = new Date().toLocaleString();
        saveBackOfficeData();
        alert(translations[currentLanguage].success);
    }
}

function loadSalesView() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('analysisDateFrom').value = today;
    document.getElementById('analysisDateTo').value = today;
}

function generateSalesAnalysis() {
    const dateFrom = document.getElementById('analysisDateFrom').value;
    const dateTo = document.getElementById('analysisDateTo').value;
    
    let html = `<h3>Analyse: ${dateFrom} bis ${dateTo}</h3>`;
    html += '<table class="data-table"><tr><th>Produkt</th><th>Verk√§ufe</th><th>Umsatz</th></tr>';
    
    let totalProductSales = 0;
    products.forEach(product => {
        const count = productSalesCount[product.id] || 0;
        const revenue = count * product.price;
        totalProductSales += revenue;
        if (count > 0) {
            html += `<tr><td>${product.name}</td><td>${count}</td><td>‚Ç¨${revenue.toFixed(2)}</td></tr>`;
        }
    });
    
    html += '</table><br><h4>Gesamt Produktumsatz: ‚Ç¨' + totalProductSales.toFixed(2) + '</h4>';
    
    document.getElementById('salesAnalysisContent').innerHTML = html;
    updatePageLanguage();
}

function loadBackofficeProducts() {
    let html = '';
    products.forEach(product => {
        const sales = productSalesCount[product.id] || 0;
        html += `<div class="product-item-bo">
            <img src="${product.image || 'üñºÔ∏è'}" alt="${product.name}" style="width:50px;height:50px;border-radius:5px;">
            <div>
                <strong>${product.name}</strong><br>
                Preis: ‚Ç¨${product.price.toFixed(2)} | Kategorie: ${product.category} | Verk√§ufe: ${sales}
            </div>
            <button class="btn-delete" onclick="deleteProduct(${product.id})">üóëÔ∏è L√∂schen</button>
        </div>`;
    });
    document.getElementById('backofficeProductsList').innerHTML = html || '<p>Keine Produkte</p>';
}

function loadInventoryView() {
    let html = '<input type="text" id="inventorySearch" class="search-input" placeholder="Artikel suchen..." onkeyup="filterInventoryList()">';
    html += '<div class="inventory-list">';
    
    products.forEach(product => {
        const stock = inventoryData[product.id] || 0;
        const threshold = 10;
        const warning = stock <= threshold ? ' style="background-color: #ffebee;"' : '';
        
        html += `<div class="inventory-item"${warning}>
            <div class="inventory-item-info">
                <strong>${product.name}</strong><br>
                Lagerbestand: <span class="stock-count">${stock}</span> | Mindestbestand: ${threshold}
            </div>
            <div class="inventory-item-controls">
                <button class="btn-small" onclick="updateInventory(${product.id}, 1)">+ Hinzu</button>
                <button class="btn-small" onclick="updateInventory(${product.id}, -1)">- Weg</button>
                <input type="number" value="${stock}" onchange="setInventory(${product.id}, this.value)" style="width:60px;">
            </div>
        </div>`;
    });
    
    html += '</div>';
    document.getElementById('inventoryList').innerHTML = html;
}

function updateInventory(productId, amount) {
    inventoryData[productId] = (inventoryData[productId] || 0) + amount;
    saveBackOfficeData();
    loadInventoryView();
}

function setInventory(productId, amount) {
    inventoryData[productId] = parseInt(amount) || 0;
    saveBackOfficeData();
    loadInventoryView();
}

function filterInventoryList() {
    const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
    document.querySelectorAll('.inventory-item').forEach(item => {
        const productName = item.querySelector('strong').textContent.toLowerCase();
        item.style.display = productName.includes(searchTerm) ? 'flex' : 'none';
    });
}

function loadEmployeesView() {
    let html = '<div class="employees-table">';
    html += '<button class="btn-primary" onclick="startAllShifts()" style="margin-bottom:15px; background: #2ecc71;">‚ñ∂ Alle Schichten starten</button>';
    html += '<button class="btn-primary" onclick="endAllShifts()" style="margin-bottom:15px; background: #ff3b30;">‚èπ Alle Schichten beenden</button>';
    html += '<table class="data-table"><tr><th>Mitarbeiter</th><th>Transaktionen</th><th>Umsatz</th><th>Schichtstart</th><th>Status</th><th>Aktion</th></tr>';
    
    users.forEach(user => {
        const shift = employeeShifts[user];
        const sales = salesData[user];
        const isActive = shift.shiftStart !== null;
        const statusBadge = isActive ? '<span style="color:#2ecc71;">üü¢ Aktiv</span>' : '<span style="color:#999;">‚ö™ Inaktiv</span>';
        const actionBtn = isActive 
            ? `<button class="btn-small" onclick="endShift('${user}')" style="background:#ff3b30;">Beenden</button>`
            : `<button class="btn-small" onclick="startShift('${user}')" style="background:#2ecc71;">Starten</button>`;
        
        html += `<tr>
            <td>${user}</td>
            <td>${sales.customersCount}</td>
            <td>‚Ç¨${sales.totalSales.toFixed(2)}</td>
            <td>${shift.shiftStart ? new Date(shift.shiftStart).toLocaleTimeString('de-DE') : '-'}</td>
            <td>${statusBadge}</td>
            <td>${actionBtn}</td>
        </tr>`;
    });
    
    html += '</table></div>';
    document.getElementById('employeesList').innerHTML = html;
}

function startShift(userName) {
    const time = new Date().toISOString();
    employeeShifts[userName].shiftStart = time;
    saveBackOfficeData();
    loadEmployeesView();
    updatePageLanguage();
}

function endShift(userName) {
    employeeShifts[userName].shiftStart = null;
    saveBackOfficeData();
    loadEmployeesView();
    updatePageLanguage();
}

function startAllShifts() {
    const time = new Date().toISOString();
    users.forEach(user => {
        employeeShifts[user].shiftStart = time;
    });
    saveBackOfficeData();
    loadEmployeesView();
    updatePageLanguage();
}

function endAllShifts() {
    users.forEach(user => {
        employeeShifts[user].shiftStart = null;
    });
    saveBackOfficeData();
    loadEmployeesView();
    updatePageLanguage();
}

// Track sales by product
function trackProductSale(productId) {
    productSalesCount[productId] = (productSalesCount[productId] || 0) + 1;
    saveBackOfficeData();
}

// ========================
// REPORTING & EXPORT
// ========================

function generateDailyReport() {
    const today = new Date().toLocaleDateString('de-DE');
    let reportData = {
        date: today,
        totalSales: 0,
        totalTransactions: 0,
        employees: {},
        paymentMethods: { cash: 0, card: 0 },
        products: [],
        registers: {}
    };
    
    // Aggregate data
    Object.keys(salesData).forEach(user => {
        reportData.employees[user] = salesData[user];
        reportData.totalSales += salesData[user].totalSales;
        reportData.totalTransactions += salesData[user].customersCount;
    });
    
    // Payment methods
    reportData.paymentMethods.cash = registerData['1'].cashSales + registerData['2'].cashSales;
    reportData.paymentMethods.card = registerData['1'].cardSales + registerData['2'].cardSales;
    
    // Products
    products.forEach(product => {
        const count = productSalesCount[product.id] || 0;
        if (count > 0) {
            reportData.products.push({
                name: product.name,
                count: count,
                revenue: count * product.price
            });
        }
    });
    
    reportData.registers['1'] = registerData['1'];
    reportData.registers['2'] = registerData['2'];
    
    return reportData;
}

function exportReportAsJSON() {
    const report = generateDailyReport();
    const dataStr = JSON.stringify(report, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `PayBox_Report_${new Date().toLocaleDateString('de-DE')}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}

function exportReportAsCSV() {
    const report = generateDailyReport();
    let csv = 'PayBox Tagesbericht\n';
    csv += `Datum,${report.date}\n\n`;
    
    csv += 'Umsatz & Transaktionen\n';
    csv += `Gesamtumsatz,‚Ç¨${report.totalSales.toFixed(2)}\n`;
    csv += `Gesamttransaktionen,${report.totalTransactions}\n\n`;
    
    csv += 'Mitarbeiter\n';
    csv += 'Mitarbeiter,Umsatz,Transaktionen\n';
    Object.keys(report.employees).forEach(user => {
        const emp = report.employees[user];
        csv += `${user},‚Ç¨${emp.totalSales.toFixed(2)},${emp.customersCount}\n`;
    });
    
    csv += '\nZahlungsmethoden\n';
    csv += 'Methode,Betrag\n';
    csv += `Bargeld,‚Ç¨${report.paymentMethods.cash.toFixed(2)}\n`;
    csv += `Karte,‚Ç¨${report.paymentMethods.card.toFixed(2)}\n\n`;
    
    csv += 'Produkte\n';
    csv += 'Produkt,Verk√§ufe,Umsatz\n';
    report.products.forEach(product => {
        csv += `${product.name},${product.count},‚Ç¨${product.revenue.toFixed(2)}\n`;
    });
    
    const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
    const exportFileDefaultName = `PayBox_Report_${new Date().toLocaleDateString('de-DE')}.csv`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}

function generateHTMLReport() {
    const report = generateDailyReport();
    const today = new Date();
    
    let html = `
    <!DOCTYPE html>
    <html lang="de">
    <head>
        <meta charset="UTF-8">
        <title>PayBox Bericht - ${report.date}</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
            h1, h2 { color: #333; }
            .report-container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th { background: #00d4ff; color: white; padding: 10px; text-align: left; }
            td { border-bottom: 1px solid #ddd; padding: 10px; }
            tr:hover { background: #f9f9f9; }
            .kpi { display: inline-block; margin: 10px 20px 10px 0; }
            .kpi-value { font-size: 24px; font-weight: bold; color: #00d4ff; }
            .kpi-label { color: #666; font-size: 12px; text-transform: uppercase; }
            .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }
        </style>
    </head>
    <body>
        <div class="report-container">
            <h1>PayBox Tagesbericht</h1>
            <p><strong>Datum:</strong> ${report.date}</p>
            <p><strong>Uhrzeit:</strong> ${today.toLocaleTimeString('de-DE')}</p>
            
            <h2>KPI √úbersicht</h2>
            <div class="kpi">
                <div class="kpi-value">‚Ç¨${report.totalSales.toFixed(2)}</div>
                <div class="kpi-label">Gesamtumsatz</div>
            </div>
            <div class="kpi">
                <div class="kpi-value">${report.totalTransactions}</div>
                <div class="kpi-label">Transaktionen</div>
            </div>
            <div class="kpi">
                <div class="kpi-value">‚Ç¨${report.totalTransactions > 0 ? (report.totalSales / report.totalTransactions).toFixed(2) : '0.00'}</div>
                <div class="kpi-label">√ò Ticketgr√∂√üe</div>
            </div>
            
            <h2>Verk√§ufe nach Mitarbeiter</h2>
            <table>
                <tr><th>Mitarbeiter</th><th>Umsatz</th><th>Transaktionen</th></tr>
                ${Object.keys(report.employees).map(user => {
                    const emp = report.employees[user];
                    return `<tr><td>${user}</td><td>‚Ç¨${emp.totalSales.toFixed(2)}</td><td>${emp.customersCount}</td></tr>`;
                }).join('')}
            </table>
            
            <h2>Zahlungsmethoden</h2>
            <table>
                <tr><th>Methode</th><th>Betrag</th><th>% vom Umsatz</th></tr>
                <tr>
                    <td>Bargeld</td>
                    <td>‚Ç¨${report.paymentMethods.cash.toFixed(2)}</td>
                    <td>${report.totalSales > 0 ? ((report.paymentMethods.cash / report.totalSales) * 100).toFixed(1) : '0'}%</td>
                </tr>
                <tr>
                    <td>Karte</td>
                    <td>‚Ç¨${report.paymentMethods.card.toFixed(2)}</td>
                    <td>${report.totalSales > 0 ? ((report.paymentMethods.card / report.totalSales) * 100).toFixed(1) : '0'}%</td>
                </tr>
            </table>
            
            <h2>Top Produkte</h2>
            <table>
                <tr><th>Produkt</th><th>Verk√§ufe</th><th>Umsatz</th></tr>
                ${report.products.sort((a, b) => b.revenue - a.revenue).slice(0, 10).map(product => 
                    `<tr><td>${product.name}</td><td>${product.count}</td><td>‚Ç¨${product.revenue.toFixed(2)}</td></tr>`
                ).join('')}
            </table>
            
            <div class="footer">
                <p>Bericht generiert mit PayBox v1.0 | ${today.toLocaleString('de-DE')}</p>
            </div>
        </div>
    </body>
    </html>
    `;
    
    return html;
}

function viewHTMLReport() {
    const html = generateHTMLReport();
    const newWindow = window.open();
    newWindow.document.write(html);
    newWindow.document.close();
}

function printReport() {
    const html = generateHTMLReport();
    const newWindow = window.open();
    newWindow.document.write(html);
    newWindow.document.close();
    setTimeout(() => {
        newWindow.print();
    }, 250);
}

